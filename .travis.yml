language: scala
sudo: false

cache:
  directories:
    $HOME/.ivy2
    $HOME/.sbt
    $INSTALL_DIR

git:
  depth: 10

env:
  global:
    INSTALL_DIR=$TRAVIS_BUILD_DIR/install
    PATH=$PATH:$TRAVIS_BUILD_DIR/utils/bin
    SBT_ARGS="-Dsbt.log.noformat=true"

before_script:
  - OLDEST_SHARED=`git log --format=%H $TRAVIS_COMMIT_RANGE | tail -n1`
  - OLDEST_COMMIT=`git log --format=%H | tail -n1`
  - if [ $OLDEST_SHARED == $OLDEST_COMMIT ]; then git fetch --unshallow; fi

stages:
  - prepare
  - test

# We do not use the built-in tests as generated by using multiple Scala
# versions because the cache is not shared between stages with any
# environmental differences.
# Instead, we specify the version of Scala manually for each test (or leave it
# as the default as defined in FIRRTL's build.sbt).
jobs:
  include:
    # Because these write to the same install directory, they must run in the
    # same script
    - stage: test
      name: "Unidoc builds (no warnings)"
      script:
        - sbt $SBT_ARGS unidoc
    - stage: test
      name: "Tests: FIRRTL (2.11)"
      script:
        - sbt ++2.11.12 $SBT_ARGS test
